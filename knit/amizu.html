<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>編み図つくーる</title>

    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>

    <style>
        #canvas {
          background-color: #e1eec1;
        }

        .imgKigou {
            width: auto;
            padding:0;
            margin:0;
            background:none;
            border:0;
            font-size:0;
            line-height:0;
            overflow:visible;
            cursor:pointer;
        }
    </style>

</head>
<body>
    <canvas id="canvas" width="640" height="480">
        <p>canvas未サポートのため表示できません</p>
    </canvas>

    <div>
        <button id="add">追加</button>
    </div>

    <div>
        <button id="kusari" class="imgKigou"><img src="image/kusari.png" alt="button"  /></button>
        <button id="koma" class="imgKigou"><img src="image/koma.png" alt="button"  /></button>
    </div>

    <div>
        <button id="btnClear">クリア</button>
    </div>

    <a id="btnDL" href="#" download="canvas.jpg">ダウンロード</a>  

    <script>
        
        let canvas  = document.getElementById('canvas');
        let context = canvas.getContext('2d');
        let isDragging = false;
        let dragTarget = null; // ドラッグ対象の画像の添え字
    
        // 定数
        const cnvWidth = 640;
        const cnvHeight = 480;  

        // 編み目記号の判断
        var pattern = 0;

        // 編み目記号のセット
        var KIGOU = {
            KUSARI : 1,
            KOMA : 2
        };

        let srcs = [];
        let images = [];
        let count = 0;


        // 編み目記号の選択
        $("#kusari").click(function(){
            if(pattern == KIGOU.KUSARI){
                pattern = 0;
                return;
            }
            pattern = KIGOU.KUSARI;
        });

        $("#koma").click(function(){
            if(pattern == KIGOU.KOMA){
                pattern = 0;
                return;
            }
            pattern = KIGOU.KOMA;
        });

        // 編み目記号の描写
        $("#add").click(function(){
            if(pattern == 0){
                return;
            }

            switch(pattern){
                case KIGOU.KUSARI:
                    srcs.push("image/kusari.png");
                    break;
                case KIGOU.KOMA:
                    srcs.push("image/koma.png");
                    break;
                default:
                    break;
            }

            images[count] = new Image();
            images[count].src = srcs[count];

            draw(count);
            count++;
        });

        
        function draw(i){
            images[i].addEventListener('load', function() {     
                context.clearRect(0, 0, canvas.width, canvas.height);              
                var x = 0;
                var y = 0;
                var w = 60;
                var h = 40;
                
                for (var j in images) {
                    // 画像を描画した時の情報を記憶（Imageのプロパティに突っ込むのはちょっと反則かもだけど）                   
                    if (j < i){
                        x = images[j].drawOffsetX;
                        y = images[j].drawOffsetY;
                    }
                    // 新規
                    else{
                        images[j].drawOffsetX = x;
                        images[j].drawOffsetY = y;
                    }
                    images[j].drawWidth   = w;
                    images[j].drawHeight  = h;
    
                    // 画像を描画
                    context.drawImage(images[j], x, y, w, h);  
                    x += 10;
                    y += 10;      
                } 
            }, false);
        }
        
        
        
        // ドラッグ開始
        var mouseDown = function(e) {
            // ドラッグ開始位置
            var posX = parseInt(e.clientX - canvas.offsetLeft);
            var posY = parseInt(e.clientY - canvas.offsetTop);
    
            for (var i = images.length - 1; i >= 0; i--) {
                // 当たり判定（ドラッグした位置が画像の範囲内に収まっているか）
                if (posX >= images[i].drawOffsetX &&
                    posX <= (images[i].drawOffsetX + images[i].drawWidth) &&
                    posY >= images[i].drawOffsetY &&
                    posY <= (images[i].drawOffsetY + images[i].drawHeight)
                ) {
                  dragTarget = i;
                  isDragging = true;
                  break;
                }
            }
        }
    
        // ドラッグ終了
        var mouseUp = function(e) {
            isDragging = false;
        };
    
        // canvasの枠から外れた
        var mouseOut = function(e) {
            // canvas外にマウスカーソルが移動した場合に、ドラッグ終了としたい場合はコメントインする
            // mouseUp(e);
        }
    
        // ドラッグ中
        var mouseMove = function(e) {
            // ドラッグ終了位置
            var posX = parseInt(e.clientX - canvas.offsetLeft);
            var posY = parseInt(e.clientY - canvas.offsetTop);
    
            if (isDragging) {
                // canvas内を一旦クリア
                context.clearRect(0, 0, canvas.width, canvas.height);
    
                var x = 0;
                var y = 0;

                for (var i in images) {
                    if (i == dragTarget) {
                        x = posX - images[i].drawWidth / 2;
                        y = posY - images[i].drawHeight / 2;
    
                        // ドラッグが終了した時の情報を記憶
                        images[i].drawOffsetX = x;
                        images[i].drawOffsetY = y;
                    } else {
                        x = images[i].drawOffsetX;
                        y = images[i].drawOffsetY;
                    }
                    w = images[i].drawWidth;
                    h = images[i].drawHeight;
    
                    // 画像を描画
                    context.drawImage(images[i], x, y, w, h);
                }
            }
        };

        // クリア処理
        $("#btnClear").click(function(){
            context.clearRect(0, 0, cnvWidth, cnvHeight);
            count = 0;
            srcs = [];
            images = [];
            pattern = 0;
        });

        // ダウンロード処理
        $("#btnDL").click(function(){
            canvas = document.getElementById('canvas');
            var base64 = canvas.toDataURL("image/jpeg");
            document.getElementById("btnDL").href = base64;
        });


        // canvasにイベント登録
        canvas.addEventListener('mousedown', function(e){mouseDown(e);}, false);
        canvas.addEventListener('mousemove', function(e){mouseMove(e);}, false);
        canvas.addEventListener('mouseup',   function(e){mouseUp(e);},   false);
        canvas.addEventListener('mouseout',  function(e){mouseOut(e);},  false);
        
    </script>
    </body>
</html>